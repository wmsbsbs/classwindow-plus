<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <title>作业</title>
    <script type="module" src="https://unpkg.com/@fluentui/web-components"></script>
    <link rel="stylesheet" href="../assets/css/main.css">
    <link rel="stylesheet" href="../assets/css/hide-scrollbar.css">
    </link>
</head>

<body>
    <!-- 加载动画 -->
    <div id="loading" class="loading-overlay">
        <div class="loading-spinner"></div>
        <p>加载中...</p>
    </div>

    <div class="content">
        <!-- 作业卡片 -->
        <div class="card homework-card" id="homeworkCard">
            <h3>作业</h3>
            <div class="homework-list" id="homeworkList">
                <!-- 作业将在这里显示 -->
            </div>
            <div class="homework-btn-container">
                <fluent-button appearance="accent" id="addHomeworkBtn">添加作业</fluent-button>
                <fluent-button appearance="primary" id="viewAllHomeworkBtn">查看全部</fluent-button>
            </div>
        </div>
    </div>
</body>
<script>
    // 导入 IPC 通信
    const { ipcRenderer } = require('electron');

        // 防止click事件在空白区域时被拦截
    const homeworkCard = document.getElementById('homeworkCard');
    if (homeworkCard) {
        homeworkCard.addEventListener('mouseenter', () =>
            ipcRenderer.send('set-ignore-mouse-events', { ignore: false })
        );

        homeworkCard.addEventListener('mouseleave', () =>
            ipcRenderer.send('set-ignore-mouse-events', {
                ignore: true,
                forward: true
            })
        );
    }

    // 添加作业显示状态变量
    let isHomeworkVisible = true;
    // 添加暗色主题状态变量
    let isDarkThemeEnabled = false;
    // 在 DOMContentLoaded 事件中添加
    const viewAllHomeworkBtn = document.getElementById('viewAllHomeworkBtn');

    // 打开全部作业窗口
    viewAllHomeworkBtn.addEventListener('click', () => {
        // 检查是否在 Electron 环境中
        if (typeof require !== 'undefined') {
            try {
                ipcRenderer.send('open-homework-list-window');
            } catch (e) {
                console.log('Not in Electron environment');
            }
        } else {
            console.log('Not in Electron environment');
        }
    });

    // 控制作业显示的函数
    function updateHomeworkVisibility() {
        if (!isHomeworkVisible) {
            // 如果作业被禁用，隐藏作业相关元素
            document.getElementById('homeworkCard').style.display = 'none';
        } else {
            // 如果作业启用，确保元素可见
            document.getElementById('homeworkCard').style.display = 'block';
            document.getElementById('addHomeworkBtn').style.display = 'inline-block';
            document.getElementById('homeworkList').style.display = 'block';
            const homeworkHeaders = document.querySelectorAll('h3');
            if (homeworkHeaders[0]) {
                homeworkHeaders[0].style.display = 'block';
            }
        }
    }

    // 添加切换主题的函数
    function toggleTheme(enabled) {
        isDarkThemeEnabled = enabled;

        if (enabled) {
            // 使用暗色主题CSS
            const darkThemeLink = document.createElement('link');
            darkThemeLink.rel = 'stylesheet';
            darkThemeLink.href = '../assets/css/main-dark.css';
            darkThemeLink.id = 'theme-stylesheet'; // 添加ID以便后续引用

            // 移除现有的主题链接
            const existingTheme = document.querySelector('link[href*="main.css"]');
            if (existingTheme && !existingTheme.href.includes('main-dark.css')) {
                existingTheme.remove();
            }

            // 添加暗色主题链接
            document.head.appendChild(darkThemeLink);
        } else {
            // 使用默认主题CSS
            const lightThemeLink = document.createElement('link');
            lightThemeLink.rel = 'stylesheet';
            lightThemeLink.href = '../assets/css/main.css';
            lightThemeLink.id = 'theme-stylesheet'; // 添加ID以便后续引用

            // 移除现有的主题链接
            const existingTheme = document.querySelector('link[href*="main-dark.css"]');
            if (existingTheme) {
                existingTheme.remove();
            }

            // 添加浅色主题链接
            document.head.appendChild(lightThemeLink);
        }
    }

    // DOM加载完成后的初始化
    document.addEventListener('DOMContentLoaded', () => {
        // 隐藏加载动画并显示内容
        const loadingOverlay = document.getElementById('loading');
        const content = document.querySelector('.content');

        // 稍微延迟隐藏加载动画，让用户看到加载过程
        setTimeout(() => {
            loadingOverlay.style.display = 'none';
            content.classList.add('loaded');
        }, 500);

        // 获取DOM元素
        const addHomeworkBtn = document.getElementById('addHomeworkBtn');
        const homeworkList = document.getElementById('homeworkList');
        // 从json加载作业数据
        let homeworkData = [];

        // 获取作业列表
        function fetchHomeworkList() {
            const { ipcRenderer } = require('electron');
            // 请求作业列表
            ipcRenderer.send('get-homework-list');

            // 监听响应
            ipcRenderer.on('homework-list-response', (event, homeworkList) => {
                homeworkData = homeworkList;
                renderHomeworkList();
            });
        }

        // 添加获取科目名称的函数
        function getSubjectName(subjectKey) {
            const subjectNames = {
                'chinese': '语文',
                'math': '数学',
                'english': '英语',
                'physics': '物理',
                'chemistry': '化学',
                'biology': '生物',
                'politics': '政治',
                'history': '历史',
                'geography': '地理',
                'technology': '技术'
            };

            return subjectNames[subjectKey] || subjectKey; // 如果找不到对应名称，则返回原始键值
        }

        // 显示作业列表
        function renderHomeworkList() {
            if (!isHomeworkVisible) {
                return; // 如果作业功能被禁用，则不渲染
            }

            homeworkList.innerHTML = '';
            if (homeworkData.length === 0) {
                homeworkList.innerHTML = '<p style="text-align:center; opacity:0.7;">暂无作业</p>';
                return;
            }

            homeworkData.forEach((item, index) => {
                const homeworkItem = document.createElement('div');
                homeworkItem.className = 'homework-item';

                // 格式化截止日期
                let dueDateStr = '';
                if (item.dueDate) {
                    const date = new Date(item.dueDate);
                    // 检查是否是当天
                    const today = new Date();
                    if (!(date.getFullYear() === today.getFullYear() &&
                        date.getMonth() === today.getMonth() &&
                        date.getDate() === today.getDate())) {
                        dueDateStr = `<br> 截止: ${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
                    }
                }

                // 将换行符替换为<br>标签
                const contentWithLineBreaks = item.content.replace(/\n/g, '<br>');

                homeworkItem.innerHTML = `
          <div>
            <span class="subject-tag ${item.subject}">${getSubjectName(item.subject)}</span>
            ${contentWithLineBreaks}${dueDateStr}
          </div>
          <button class="delete-btn" id="delete-btn" data-index="${index}">删除</button>
        `;
                homeworkList.appendChild(homeworkItem);
            });

            // 添加删除按钮事件监听
            document.querySelectorAll('.delete-btn').forEach(button => {
                button.addEventListener('click', function () {
                    const index = parseInt(this.getAttribute('data-index'));
                    if (typeof require !== 'undefined') {
                        try {
                            const { ipcRenderer } = require('electron');
                            ipcRenderer.send('delete-homework', index);
                        } catch (e) {
                            console.log('Not in Electron environment');
                        }
                    } else {
                        console.log('Not in Electron environment');
                    }
                });
            });
        }

        // 打开新窗口添加作业
        addHomeworkBtn.addEventListener('click', () => {
            // 检查是否在 Electron 环境中
            if (typeof require !== 'undefined') {
                try {
                    const { ipcRenderer } = require('electron');
                    ipcRenderer.send('open-homework-window');
                } catch (e) {
                    console.log('Not in Electron environment');
                }
            } else {
                console.log('Not in Electron environment');
            }
        });

        // 接收来自新窗口的作业数据和开关状态
        if (typeof require !== 'undefined') {
            try {
                const { ipcRenderer } = require('electron');

                // 监听新作业数据
                ipcRenderer.on('new-homework', (event, homework) => {
                    // 重新获取最新的作业列表
                    fetchHomeworkList();
                });

                // 监听作业列表刷新
                ipcRenderer.on('refresh-homework-list', (event) => {
                    fetchHomeworkList();
                });

                // 监听作业开关事件
                ipcRenderer.on('homework-toggle', (event, isEnabled) => {
                    isHomeworkVisible = isEnabled;
                    updateHomeworkVisibility();
                    renderHomeworkList(); // 重新渲染作业列表
                });

                // 监听启动台应用更新事件（从主进程传递过来）
                ipcRenderer.on('launchpad-apps-updated', (event, apps) => {
                    launchpadApps = apps;
                    // 这里不需要做任何操作，因为作业窗口不显示启动台
                });

                // 监听暗色主题切换事件
                ipcRenderer.on('dark-theme-toggle', (event, isEnabled) => {
                    toggleTheme(isEnabled);
                });

            } catch (e) {
                console.log('Not in Electron environment');
            }
        }

        // 初始化作业列表
        updateHomeworkVisibility(); // 初始化作业可见性
        fetchHomeworkList(); // 改为从主进程获取作业列表
    });
</script>

</html>